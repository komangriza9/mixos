name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.21'
  VERSION: '1.0.0'
  # Standardized directory structure
  BUILD_DIR: /tmp/mixos-build
  OUTPUT_DIR: ${{ github.workspace }}/artifacts

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential squashfs-tools xorriso grub-common git qemu-system-x86

      - name: Run Go vet and tests (mix-cli)
        working-directory: src/mix-cli
        run: |
          go mod tidy
          go vet ./...
          go test ./... -v

      - name: Run Go vet and tests (installer)
        working-directory: src/installer
        run: |
          go mod tidy
          go vet ./...
          go test ./... -v

      - name: Build binaries
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}/boot ${{ env.OUTPUT_DIR }}/packages
          
          # Build mix-cli
          cd src/mix-cli
          go build -ldflags='-s -w' -o ${{ env.OUTPUT_DIR }}/mix .
          chmod +x ${{ env.OUTPUT_DIR }}/mix
          
          # Build installer (static, no cgo)
          cd ../installer
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags='-s -w' -o ${{ env.OUTPUT_DIR }}/mixos-install .
          chmod +x ${{ env.OUTPUT_DIR }}/mixos-install
          
          echo "=== Built binaries ==="
          ls -lah ${{ env.OUTPUT_DIR }}/

      - name: Smoke check binaries
        run: |
          if [ -f ${{ env.OUTPUT_DIR }}/mixos-install ]; then
            ${{ env.OUTPUT_DIR }}/mixos-install --version
          else
            echo "Installer binary not found"; exit 1
          fi
          if [ -f ${{ env.OUTPUT_DIR }}/mix ]; then
            ${{ env.OUTPUT_DIR }}/mix --help >/dev/null || echo 'mix help check'
          fi

      - name: Autoinstall dry-run
        run: |
          if [ -f ${{ env.OUTPUT_DIR }}/mixos-install ]; then
            ${{ env.OUTPUT_DIR }}/mixos-install --config packaging/install.yaml --dry-run
          else
            echo "Installer binary not found"; exit 1
          fi

      - name: Build packages (optional)
        run: |
          export BUILD_DIR=${{ env.BUILD_DIR }}
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          export REPO_ROOT=${{ github.workspace }}
          make packages || true

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mixos-artifacts
          path: ${{ env.OUTPUT_DIR }}/
