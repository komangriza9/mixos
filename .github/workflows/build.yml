name: MixOS-GO Build

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - viso-only

env:
  GO_VERSION: '1.21'
  KERNEL_VERSION: '6.6.8'
  VERSION: '1.0.0'
  # Standardized directory structure
  BUILD_DIR: /tmp/mixos-build
  OUTPUT_DIR: ${{ github.workspace }}/artifacts

jobs:
  # ============================================================================
  # Test Mix CLI
  # ============================================================================
  test-mix-cli:
    name: Test Mix CLI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run vet and tests
        working-directory: src/mix-cli
        run: |
          go mod tidy
          go vet ./...
          go test -v ./...

      - name: Build mix binary
        working-directory: src/mix-cli
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}
          CGO_ENABLED=1 go build -ldflags="-s -w -X main.Version=${{ env.VERSION }}" -o ${{ env.OUTPUT_DIR }}/mix .
          chmod +x ${{ env.OUTPUT_DIR }}/mix
          ${{ env.OUTPUT_DIR }}/mix --version || echo "mix --version check"

      - name: Upload mix-cli
        uses: actions/upload-artifact@v4
        with:
          name: mix-cli
          path: ${{ env.OUTPUT_DIR }}/mix

  # ============================================================================
  # Build Installer
  # ============================================================================
  build-installer:
    name: Build Installer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build installer binary
        working-directory: src/installer
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}
          go mod tidy
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ${{ env.OUTPUT_DIR }}/mixos-install .
          chmod +x ${{ env.OUTPUT_DIR }}/mixos-install

      - name: Smoke check installer
        run: |
          ${{ env.OUTPUT_DIR }}/mixos-install --version

      - name: Autoinstall dry-run
        run: |
          ${{ env.OUTPUT_DIR }}/mixos-install --config packaging/install.yaml --dry-run

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: ${{ env.OUTPUT_DIR }}/mixos-install

  # ============================================================================
  # Build Kernel (with mixmagisk support)
  # ============================================================================
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            bc \
            bison \
            flex \
            libelf-dev \
            libssl-dev \
            libncurses-dev \
            git \
            cpio

      - name: Cache kernel source
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_DIR }}/linux-${{ env.KERNEL_VERSION }}
          key: kernel-${{ env.KERNEL_VERSION }}-mixmagisk

      - name: Build kernel
        run: |
          export BUILD_DIR=${{ env.BUILD_DIR }}
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          export REPO_ROOT=${{ github.workspace }}
          mkdir -p $OUTPUT_DIR/boot
          bash build/scripts/build-kernel.sh
        timeout-minutes: 60

      - name: Verify kernel artifacts
        run: |
          echo "=== Kernel artifacts ==="
          ls -la ${{ env.OUTPUT_DIR }}/
          ls -la ${{ env.OUTPUT_DIR }}/boot/ || true
          echo "Kernel: $(ls -lh ${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos 2>/dev/null || echo 'not found')"
          echo "Modules: $(ls -lh ${{ env.OUTPUT_DIR }}/modules-mixos.tar.gz 2>/dev/null || echo 'not found')"

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel
          path: |
            ${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos
            ${{ env.OUTPUT_DIR }}/vmlinuz-mixos
            ${{ env.OUTPUT_DIR }}/modules-mixos.tar.gz

  # ============================================================================
  # Build Packages
  # ============================================================================
  build-packages:
    name: Build Packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            git

      - name: Build packages
        run: |
          export BUILD_DIR=${{ env.BUILD_DIR }}
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          export REPO_ROOT=${{ github.workspace }}
          mkdir -p ${{ env.OUTPUT_DIR }}/packages
          mkdir -p ${{ env.BUILD_DIR }}
          for pkg in src/packages/*/build.sh; do
            if [ -f "$pkg" ]; then
              echo "Building $(basename $(dirname $pkg))..."
              bash "$pkg" || true
            fi
          done

      - name: List packages
        run: |
          echo "Built packages:"
          ls -lah ${{ env.OUTPUT_DIR }}/packages/ 2>/dev/null || echo "No packages built"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: ${{ env.OUTPUT_DIR }}/packages/

  # ============================================================================
  # Build Rootfs
  # ============================================================================
  build-rootfs:
    name: Build Root Filesystem
    runs-on: ubuntu-latest
    needs: [test-mix-cli, build-installer, build-kernel, build-packages]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            squashfs-tools \
            cpio \
            git

      - name: Download mix-cli
        uses: actions/download-artifact@v4
        with:
          name: mix-cli
          path: ${{ env.OUTPUT_DIR }}/

      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: installer
          path: ${{ env.OUTPUT_DIR }}/

      - name: Download kernel artifacts
        uses: actions/download-artifact@v4
        with:
          name: kernel
          path: ${{ env.OUTPUT_DIR }}/

      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: ${{ env.OUTPUT_DIR }}/packages/

      - name: Prepare artifacts structure
        run: |
          # Ensure proper directory structure
          mkdir -p ${{ env.OUTPUT_DIR }}/boot
          mkdir -p ${{ env.BUILD_DIR }}
          
          # Move kernel to boot/ if it's in root
          if [ -f "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" ] && [ ! -f "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos" ]; then
            cp "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos"
          fi
          
          # Make binaries executable
          chmod +x ${{ env.OUTPUT_DIR }}/mix 2>/dev/null || true
          chmod +x ${{ env.OUTPUT_DIR }}/mixos-install 2>/dev/null || true
          
          echo "=== Artifacts structure ==="
          find ${{ env.OUTPUT_DIR }} -type f | head -50

      - name: Build rootfs
        run: |
          export BUILD_DIR=${{ env.BUILD_DIR }}
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          export REPO_ROOT=${{ github.workspace }}
          bash build/scripts/build-rootfs.sh

      - name: Verify rootfs
        run: |
          echo "=== Rootfs structure ==="
          ls -la ${{ env.BUILD_DIR }}/rootfs/ || echo "Rootfs not found"
          echo "=== Rootfs size ==="
          du -sh ${{ env.BUILD_DIR }}/rootfs/ || true

      - name: Upload rootfs
        uses: actions/upload-artifact@v4
        with:
          name: rootfs
          path: ${{ env.BUILD_DIR }}/rootfs/

  # ============================================================================
  # Build Initramfs (VISO/VRAM support)
  # ============================================================================
  build-initramfs:
    name: Build Initramfs (VISO/VRAM)
    runs-on: ubuntu-latest
    needs: [build-rootfs, build-kernel]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cpio gzip xz-utils build-essential

      - name: Download rootfs
        uses: actions/download-artifact@v4
        with:
          name: rootfs
          path: ${{ env.BUILD_DIR }}/rootfs/

      - name: Download kernel artifacts
        uses: actions/download-artifact@v4
        with:
          name: kernel
          path: ${{ env.OUTPUT_DIR }}/

      - name: Prepare artifacts structure
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}/boot
          
          # Move kernel to boot/ if needed
          if [ -f "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" ] && [ ! -f "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos" ]; then
            cp "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos"
          fi
          
          # Extract modules to rootfs if available
          if [ -f "${{ env.OUTPUT_DIR }}/modules-mixos.tar.gz" ]; then
            echo "Extracting kernel modules to rootfs..."
            tar -xzf "${{ env.OUTPUT_DIR }}/modules-mixos.tar.gz" -C ${{ env.BUILD_DIR }}/rootfs/
            ls -la ${{ env.BUILD_DIR }}/rootfs/lib/modules/ || true
          fi
          
          echo "=== Artifacts structure ==="
          find ${{ env.OUTPUT_DIR }} -type f | head -20

      - name: Build initramfs
        run: |
          export BUILD_DIR=${{ env.BUILD_DIR }}
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          export REPO_ROOT=${{ github.workspace }}
          bash build/scripts/build-initramfs.sh

      - name: Verify initramfs
        run: |
          echo "=== Initramfs ==="
          ls -la ${{ env.OUTPUT_DIR }}/boot/ || echo "Boot dir not found"

      - name: Upload initramfs
        uses: actions/upload-artifact@v4
        with:
          name: initramfs
          path: ${{ env.OUTPUT_DIR }}/boot/initramfs-mixos.img

  # ============================================================================
  # Build VISO
  # ============================================================================
  build-viso:
    name: Build VISO Image
    runs-on: ubuntu-latest
    needs: [build-rootfs, build-initramfs, build-kernel]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            squashfs-tools \
            qemu-utils \
            grub-pc-bin \
            grub-efi-amd64-bin \
            xorriso \
            mtools

      - name: Download rootfs
        uses: actions/download-artifact@v4
        with:
          name: rootfs
          path: ${{ env.BUILD_DIR }}/rootfs/

      - name: Download initramfs
        uses: actions/download-artifact@v4
        with:
          name: initramfs
          path: ${{ env.OUTPUT_DIR }}/boot/

      - name: Download kernel
        uses: actions/download-artifact@v4
        with:
          name: kernel
          path: ${{ env.OUTPUT_DIR }}/

      - name: Prepare artifacts structure
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}/boot
          
          # Move kernel to boot/ if needed
          if [ -f "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" ] && [ ! -f "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos" ]; then
            cp "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos"
          fi
          
          echo "=== Artifacts structure ==="
          echo "OUTPUT_DIR contents:"
          find ${{ env.OUTPUT_DIR }} -type f
          echo "BUILD_DIR/rootfs contents (first 20):"
          find ${{ env.BUILD_DIR }}/rootfs -type f | head -20

      - name: Build VISO
        run: |
          export BUILD_DIR=${{ env.BUILD_DIR }}
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          export REPO_ROOT=${{ github.workspace }}
          export VERSION=${{ env.VERSION }}
          bash build/scripts/build-viso.sh

      - name: Upload VISO
        uses: actions/upload-artifact@v4
        with:
          name: viso
          path: |
            ${{ env.OUTPUT_DIR }}/*.viso
            ${{ env.OUTPUT_DIR }}/*.viso.tar.gz
            ${{ env.OUTPUT_DIR }}/*.vram.tar.gz

  # ============================================================================
  # Build ISO
  # ============================================================================
  build-iso:
    name: Build ISO Image
    runs-on: ubuntu-latest
    needs: [build-rootfs, build-initramfs, build-kernel]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            squashfs-tools \
            grub-pc-bin \
            grub-efi-amd64-bin \
            xorriso \
            mtools \
            genisoimage \
            qemu-system-x86

      - name: Download rootfs
        uses: actions/download-artifact@v4
        with:
          name: rootfs
          path: ${{ env.BUILD_DIR }}/rootfs/

      - name: Download initramfs
        uses: actions/download-artifact@v4
        with:
          name: initramfs
          path: ${{ env.OUTPUT_DIR }}/boot/

      - name: Download kernel
        uses: actions/download-artifact@v4
        with:
          name: kernel
          path: ${{ env.OUTPUT_DIR }}/

      - name: Prepare artifacts structure
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}/boot
          
          # Move kernel to boot/ if needed
          if [ -f "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" ] && [ ! -f "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos" ]; then
            cp "${{ env.OUTPUT_DIR }}/vmlinuz-mixos" "${{ env.OUTPUT_DIR }}/boot/vmlinuz-mixos"
          fi
          
          echo "=== Artifacts structure ==="
          echo "OUTPUT_DIR contents:"
          find ${{ env.OUTPUT_DIR }} -type f
          echo "BUILD_DIR/rootfs contents (first 20):"
          find ${{ env.BUILD_DIR }}/rootfs -type f | head -20

      - name: Build ISO
        run: |
          export BUILD_DIR=${{ env.BUILD_DIR }}
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          export REPO_ROOT=${{ github.workspace }}
          export VERSION=${{ env.VERSION }}
          bash build/scripts/build-iso.sh

      - name: Smoke boot ISO (QEMU)
        run: |
          ISO=$(ls ${{ env.OUTPUT_DIR }}/*.iso 2>/dev/null | head -n1 || true)
          if [ -z "$ISO" ]; then
            echo "No ISO found in ${{ env.OUTPUT_DIR }}/; checking for tarball..."
            if [ -f "${{ env.OUTPUT_DIR }}/mixos-go-v${{ env.VERSION }}.tar.gz" ]; then
              echo "Tarball found, skipping QEMU test"
              exit 0
            fi
            echo "No ISO or tarball found; failing smoke boot"
            exit 1
          fi
          echo "Testing ISO: $ISO"
          timeout 90s qemu-system-x86_64 -cdrom "$ISO" -m 512 -nographic -serial file:./boot.log || true
          if grep -qi 'mixos\|MixOS\|login\|init' boot.log 2>/dev/null; then
            echo "ISO boot smoke test: OK"
          else
            echo "ISO boot smoke test: FAILED (or no recognizable output)"
            echo "==== Serial log (head) ===="
            head -100 boot.log || true
            # Don't fail the build for smoke test issues
          fi

      - name: Generate checksums
        run: |
          cd ${{ env.OUTPUT_DIR }}
          for f in *.iso *.tar.gz; do
            [ -f "$f" ] && sha256sum "$f" > "$f.sha256"
          done

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: iso
          path: |
            ${{ env.OUTPUT_DIR }}/*.iso
            ${{ env.OUTPUT_DIR }}/*.iso.sha256
            ${{ env.OUTPUT_DIR }}/*.tar.gz

  # ============================================================================
  # Run Tests
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [build-viso, build-iso]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.OUTPUT_DIR }}/
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== All artifacts ==="
          find ${{ env.OUTPUT_DIR }} -type f

      - name: Run VISO tests
        run: |
          export OUTPUT_DIR=${{ env.OUTPUT_DIR }}
          bash tests/test-viso.sh || echo "VISO tests completed with warnings"

  # ============================================================================
  # Release
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release/
          merge-multiple: true

      - name: List release artifacts
        run: |
          echo "=== Release artifacts ==="
          find release/ -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: MixOS-GO ${{ github.ref_name }}
          body: |
            ## MixOS-GO ${{ github.ref_name }} ðŸ§¡
            
            ### ðŸš€ Revolutionary Features
            - **VISO**: Virtual ISO format (replaces CDROM)
            - **SDISK**: Selection Disk boot mechanism
            - **VRAM**: Boot entire system from RAM
            - **mixmagisk**: Custom root management (replaces sudo)
            
            ### Downloads
            | File | Description |
            |------|-------------|
            | `mixos-go-*.viso` | VISO image (recommended for QEMU/KVM) |
            | `mixos-go-*.iso` | Traditional ISO image |
            | `mixos-go-*.vram.tar.gz` | VRAM-optimized package |
            
            ### Quick Start
            ```bash
            # VISO boot (maximum performance)
            qemu-system-x86_64 \
              -drive file=mixos-go-v${{ env.VERSION }}.viso,format=qcow2,if=virtio \
              -m 2G -enable-kvm
            
            # VRAM mode (requires 4GB+ RAM)
            qemu-system-x86_64 \
              -drive file=mixos-go-v${{ env.VERSION }}.viso,format=qcow2,if=virtio \
              -m 4G -append "VRAM=auto"
            ```
            
            ### Boot Flow
            1. Boot from VISO/ISO â†’ MixOS Installer
            2. Configure: credentials, network, disk/VRAM, profiles
            3. Reboot with configured parameters
            4. Welcome to MixOS! ðŸ§¡
          files: |
            release/*.viso
            release/*.iso
            release/*.tar.gz
            release/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
